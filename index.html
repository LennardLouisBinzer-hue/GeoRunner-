<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Geo Dash: Ultimate Endless</title>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #bc13fe;
            --neon-green: #0aff0a;
            --bg-dark: #111;
            --panel-bg: rgba(20, 20, 30, 0.98);
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: none; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.1);
            background: linear-gradient(to bottom, #1a1a2e, #0a0a15);
            display: block;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            text-shadow: 0 0 10px black;
            font-size: 1.2rem;
            pointer-events: auto;
            align-items: center;
            flex-wrap: wrap;
        }

        .hud-right { display: flex; gap: 10px; align-items: center; }
        
        /* Counter Styles */
        .coin-counter { color: #ffd700; display: flex; align-items: center; gap: 8px; }
        .score-counter { color: var(--neon-green); display: flex; align-items: center; gap: 8px; margin-right: 10px; font-family: monospace; font-size: 1.3rem;}

        /* Active Powerups HUD */
        .active-powerups {
            display: flex;
            gap:5px;
            margin-left: 10px;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 5px;
        }
        .powerup-icon {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 5px var(--neon-pink));
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse { from { opacity: 0.7; transform: scale(1); } to { opacity: 1; transform: scale(1.1); } }

        /* In-Game Effect Label */
        #effect-label {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            color: var(--neon-pink);
            font-weight: bold;
            text-transform: uppercase;
            text-shadow: 0 0 10px black;
            font-size: 1.5rem;
            pointer-events: none;
            display: none;
        }

        /* --- MODALS --- */
        .modal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--panel-bg);
            border: 2px solid var(--neon-blue);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            pointer-events: auto;
            display: none;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 0 20px var(--neon-blue);
            min-width: 320px;
            max-width: 90%;
            max-height: 90vh;
            z-index: 100;
        }

        .modal.active { display: flex; }

        /* --- FULLSCREEN SHOP --- */
        #shop-screen {
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform: none; 
            border-radius: 0;
            border: none;
            padding: 0;
            max-width: 100%; max-height: 100%;
            justify-content: space-between;
            background: rgba(10, 10, 20, 0.98);
            overflow: hidden;
        }

        .shop-header {
            padding: 15px;
            background: rgba(0,0,0,0.6);
            text-align: center;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .shop-header h2 { margin: 0; color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink); font-size: 1.2rem;}
        .shop-header p { margin: 5px 0 0 0; color: #aaa; font-size: 0.9rem;}

        /* --- KATEGORIE LEISTE --- */
        .category-bar {
            display: flex;
            background: rgba(0,0,0,0.5);
            border-bottom: 2px solid var(--neon-blue);
            flex-shrink: 0;
        }

        .cat-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #888;
            padding: 15px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .cat-btn.active {
            color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.1);
            box-shadow: inset 0 -3px 0 var(--neon-blue);
        }

        /* --- CONTENT BEREICH --- */
        .shop-content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            touch-action: pan-y;
        }

        .shop-content-area::-webkit-scrollbar { width: 8px; }
        .shop-content-area::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .shop-content-area::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 4px; }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .shop-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
        }

        .item-preview {
            width: 50px; height: 50px;
            border-radius: 5px;
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
            margin-bottom: 5px;
        }

        .item-name { font-weight: bold; font-size: 0.9rem; display: block; }
        .item-price { color: #ffd700; font-size: 0.8rem; display: block; }
        
        .powerup-item {
            background: linear-gradient(135deg, rgba(188,19,254,0.1) 0%, rgba(0,0,0,0) 100%);
            border: 1px solid var(--neon-pink);
        }
        .powerup-item.active { 
            box-shadow: 0 0 15px var(--neon-pink) inset; 
            background: rgba(188,19,254,0.2); 
            border-color: #fff;
        }

        .shop-footer {
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border-top: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        /* --- BUTTONS --- */
        button {
            background: transparent;
            color: var(--neon-blue);
            border: 2px solid var(--neon-blue);
            padding: 15px 30px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            border-radius: 5px;
            width: 100%;
        }

        button:hover { background: var(--neon-blue); color: black; box-shadow: 0 0 15px var(--neon-blue); transform: scale(1.02); }
        button:active { transform: scale(0.98); }

        button.shop-close {
            background: var(--neon-pink);
            color: white;
            border: none;
            font-size: 1.1rem;
            padding: 15px;
        }
        button.shop-close:hover { background: #d980fa; box-shadow: 0 0 15px var(--neon-pink); }

        button.action-btn {
            font-size: 0.9rem;
            padding: 8px;
            border-radius: 5px;
        }
        button.action-btn:hover { transform: none; box-shadow: none; }
        button.action-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        
        .hud-btn {
            padding: 5px 10px;
            font-size: 1.5rem;
            line-height: 0.8;
            border-radius: 5px;
            background: rgba(0,0,0,0.5);
            color: white; border: none;
        }
        .hud-btn:hover { transform: none; background: rgba(255,255,255,0.2); }

        #jump-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        
        h1 { margin: 0; color: var(--neon-blue); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px var(--neon-blue); font-size: 2rem; }
        h2 { color: var(--neon-pink); margin: 0; }
        p { margin: 0; color: #ccc; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-1px, -2px) rotate(-1deg); }
            50% { transform: translate(-1px, 2px) rotate(1deg); }
            75% { transform: translate(1px, -1px) rotate(1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake { animation: shake 0.3s; }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>
    <div id="jump-area"></div>

    <!-- Ingame Label -->
    <div id="effect-label"></div>

    <div id="ui-layer">
        <div class="hud">
            <div class="coin-counter">ü™ô <span id="coin-display">0</span></div>
            <div class="score-counter">‚è± <span id="score-display">0</span></div>
            
            <!-- Aktive Powerups Anzeige -->
            <div class="active-powerups" id="active-powerups-display">
                <!-- Wird dynamisch gef√ºllt -->
            </div>

            <div class="hud-right">
                <button onclick="quickRestart()" class="hud-btn" title="Neustart">‚Ü∫</button>
                <button onclick="togglePause()" class="hud-btn">||</button>
            </div>
        </div>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen" class="modal active">
        <h1>Geo Dash Ultimate</h1>
        <p>Unendlich & RGB Farben!</p>
        <div class="score-board" style="margin-top:20px;">
            <div class="score-box">
                <span>Dein Rekord</span>
                <span id="start-best-score" class="best-score-val">0</span>
            </div>
        </div>
        <div style="font-size: 0.9rem; color: #888; margin: 20px 0;">
            Das Level ist unendlich.
        </div>
        <button onclick="startGame()">Starten</button>
        <button class="shop-close" onclick="openShop()">Shop</button>
    </div>

    <!-- GAME OVER SCREEN -->
    <div id="crash-screen" class="modal">
        <h1 style="color: #ff3333;">Gecrasht!</h1>
        
        <div class="score-board">
            <div class="score-box">
                <span>Punkte</span>
                <span id="crash-score" class="score-val">0</span>
            </div>
            <div class="score-box">
                <span>Rekord</span>
                <span id="crash-best-score" class="best-score-val">0</span>
            </div>
        </div>

        <p>Shop verlassen = Sofort Restart.</p>
        <button onclick="resetGame()">Nochmal versuchen</button>
        <button class="shop-close" onclick="openShop()">Shop</button>
    </div>

    <!-- SHOP -->
    <div id="shop-screen" class="modal">
        <!-- Header -->
        <div class="shop-header">
            <h2>Shop</h2>
            <p>Deine Coins: <span id="shop-coins">0</span> ü™ô</p>
        </div>

        <!-- KATEGORIE LEISTE -->
        <div class="category-bar">
            <button class="cat-btn active" onclick="switchTab('skins')" id="tab-skins">Skine</button>
            <button class="cat-btn" onclick="switchTab('effects')" id="tab-effects">Effekte</button>
            <button class="cat-btn" onclick="switchTab('game')" id="tab-game">Game</button>
        </div>

        <!-- Scrollbarer Content -->
        <div class="shop-content-area" id="shop-content">
            <!-- JS rendert hier die Liste -->
        </div>

        <!-- Footer -->
        <div class="shop-footer">
            <button class="shop-close" onclick="closeShop()">Schlie√üen & Sofort Start</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'START'; 
        let currentScore = 0; 

        let playerData = {
            coins: 0,
            bestScore: 0, 
            skinColor: '#00f3ff',
            unlockedColors: ['#00f3ff'],
            doubleJumpUnlocked: false,
            doubleJumpEnabled: false
        };

        // --- SHOP DATEN ---
        const skinItems = [
            { id: 'c_blue', name: 'Blau', color: '#00f3ff', price: 0 },
            { id: 'c_red', name: 'Rot', color: '#ff0040', price: 20 },
            { id: 'c_white', name: 'Wei√ü', color: '#ffffff', price: 20 },
            { id: 'c_purple', name: 'Lila', color: '#bc13fe', price: 20 },
            { id: 'c_green', name: 'Gr√ºn (RGB)', color: '#00ff40', price: 20 }
        ];

        let currentPowerUps = {
            pu_double: false,
            pu_slow: false,
            pu_magnet: false
        };

        const effectItems = [
            { id: 'pu_double', name: 'Doppelsprung (1x)', cost: 10, icon: 'üöÄ', label: '2x SPRUNG' },
            { id: 'pu_slow', name: 'Schleichfahrt', cost: 15, icon: 'üêå', label: 'LANGSAM' },
            { id: 'pu_magnet', name: 'Magnet', cost: 20, icon: 'üß≤', label: 'MAGNET' }
        ];

        const gameItems = [
            { id: 'u_double', name: 'Doppelsprung (Dauerhaft)', price: 200, desc: 'Immer aktivierbar' }
        ];

        // --- PHYSIK ---
        const BASE_GRAVITY = 1.0;         
        const BASE_JUMP_FORCE = -15;      
        const BASE_SPEED_X = 7.5;         
        const SLOW_SPEED_X = 4.0;         
        const GROUND_Y_OFFSET = 150; 

        let GRAVITY = BASE_GRAVITY;
        let JUMP_FORCE = BASE_JUMP_FORCE;
        let SPEED_X = BASE_SPEED_X;

        const player = {
            x: 100, y: 0, w: 50, h: 50, 
            dy: 0, angle: 0, jumpsLeft: 1
        };

        let cameraX = 0;
        let blocks = [];
        let spikes = [];
        let coinsArr = [];
        let particles = [];
        
        let activeTab = 'skins'; 

        function init() {
            resize();
            window.addEventListener('resize', resize);
            try { loadData(); } catch(e) {}
            updateCoinUI();
            updateScoreUI();
            updatePowerUpHUD();
            
            window.addEventListener('keydown', (e) => {
                if ((e.code === 'Space' || e.code === 'ArrowUp') && gameState === 'PLAYING') jump();
                if (e.code === 'Escape') togglePause();
            });

            const jumpAction = (e) => {
                if(e.target.tagName === 'BUTTON' || gameState !== 'PLAYING') return;
                e.preventDefault();
                jump();
            };
            document.addEventListener('mousedown', jumpAction);
            document.addEventListener('touchstart', jumpAction, {passive: false});

            requestAnimationFrame(gameLoop);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function loadData() {
            const saved = localStorage.getItem('geoDashSaveUltimateEndless');
            if(saved) {
                const parsed = JSON.parse(saved);
                playerData = { ...playerData, ...parsed };
                if (playerData.doubleJumpUnlocked && playerData.doubleJumpEnabled === undefined) {
                    playerData.doubleJumpEnabled = true;
                }
            }
            skinItems.forEach(item => {
                if (playerData.unlockedColors.includes(item.color)) item.owned = true;
            });
            document.getElementById('start-best-score').innerText = playerData.bestScore;
        }

        function saveData() {
            localStorage.setItem('geoDashSaveUltimateEndless', JSON.stringify(playerData));
        }

        // --- LEVEL GENERIERUNG (UNENDLICH LOGIK) ---
        let lastGeneratedX = 0;

        function generateLevel() {
            // Wir l√∂schen nicht alles beim Start, sondern fangen an wo wir aufgeh√∂rt haben oder neu.
            // F√ºr den Reset (Start Game) r√§umen wir auf.
        }

        function resetGameLevel() {
            blocks = [];
            spikes = [];
            coinsArr = [];
            particles = [];
            blocks.push({ x: 0, y: canvas.height - GROUND_Y_OFFSET, w: 800, h: GROUND_Y_OFFSET });
            lastGeneratedX = 800;
        }

        function extendLevel() {
            // Generiere mehr Level, solange der Spieler sich n√§hert
            // Generiere ca 5000px auf einmal voraus
            const targetX = player.x + 4000;
            const groundLevel = canvas.height - GROUND_Y_OFFSET;
            
            while(lastGeneratedX < targetX) {
                const pattern = Math.floor(Math.random() * 7);
                
                if (pattern >= 0 && pattern <= 2) {
                    const len = 400;
                    blocks.push({ x: lastGeneratedX, y: groundLevel, w: len, h: GROUND_Y_OFFSET });
                    // Coins auf dem Boden
                    for(let i=0; i<8; i++) {
                        coinsArr.push({ x: lastGeneratedX + 30 + (i*45), y: groundLevel - 20, r: 12 }); 
                    }
                    lastGeneratedX += len;
                } 
                else if (pattern === 3) {
                    const len = 400;
                    blocks.push({ x: lastGeneratedX, y: groundLevel, w: len, h: GROUND_Y_OFFSET });
                    coinsArr.push({ x: lastGeneratedX + 50, y: groundLevel - 20, r: 12 });
                    coinsArr.push({ x: lastGeneratedX + 350, y: groundLevel - 20, r: 12 });
                    
                    spikes.push({ x: lastGeneratedX + 180, y: groundLevel - 30, w: 50, h: 50 });
                    spikes.push({ x: lastGeneratedX + 230, y: groundLevel - 30, w: 50, h: 50 });
                    lastGeneratedX += len;
                }
                else if (pattern === 4) {
                    const len = 400;
                    blocks.push({ x: lastGeneratedX, y: groundLevel, w: len, h: GROUND_Y_OFFSET });
                    coinsArr.push({ x: lastGeneratedX + 50, y: groundLevel - 20, r: 12 });
                    
                    for(let i=0; i<3; i++) {
                        spikes.push({ x: lastGeneratedX + 170 + (i*45), y: groundLevel - 30, w: 50, h: 50 });
                    }
                    lastGeneratedX += len;
                }
                else if (pattern === 5) {
                    const len = 500;
                    blocks.push({ x: lastGeneratedX, y: groundLevel, w: len, h: GROUND_Y_OFFSET });
                    for(let i=0; i<4; i++) {
                        spikes.push({ x: lastGeneratedX + 100 + (i*80), y: groundLevel - 30, w: 50, h: 50 });
                    }
                    lastGeneratedX += len;
                }
                else {
                    const gapLen = 220; 
                    const platformY = groundLevel - 80;
                    blocks.push({ x: lastGeneratedX + 80, y: platformY, w: 150, h: GROUND_Y_OFFSET });
                    for(let i=0; i<3; i++) {
                        coinsArr.push({ x: lastGeneratedX + 100 + (i*35), y: platformY - 20, r: 12 });
                    }
                    lastGeneratedX += gapLen + 50;
                }
            }
            
            // Cleanup: Entferne Objekte die weit hinter der Kamera sind (Performance)
            cleanupLevel();
        }

        function cleanupLevel() {
            // Entferne Bl√∂cke/Spikes die mehr als 2000px hinter der Kamera liegen
            const limit = cameraX - 2000;
            blocks = blocks.filter(b => b.x + b.w > limit);
            spikes = spikes.filter(s => s.x + s.w > limit);
            coinsArr = coinsArr.filter(c => c.x > limit);
        }

        // --- LOGIK ---
        function startGame() {
            hideAllModals();
            resetGameVars();
            resetGameLevel(); // Level zur√ºcksetzen
            gameState = 'PLAYING';
        }

        function resetGame() {
            hideAllModals();
            resetGameVars();
            resetGameLevel();
            gameState = 'PLAYING';
        }

        function quickRestart() {
            if (gameState === 'START') return;
            resetGameVars();
            resetGameLevel();
            gameState = 'PLAYING';
        }

        function resetGameVars() {
            SPEED_X = currentPowerUps['pu_slow'] ? SLOW_SPEED_X : BASE_SPEED_X;
            GRAVITY = currentPowerUps['pu_slow'] ? BASE_GRAVITY * 0.8 : BASE_GRAVITY;
            
            player.x = 100;
            player.y = canvas.height - GROUND_Y_OFFSET - player.h;
            player.dy = 0;
            player.angle = 0;
            
            const hasDouble = (playerData.doubleJumpUnlocked && playerData.doubleJumpEnabled) || currentPowerUps['pu_double'];
            player.jumpsLeft = hasDouble ? 2 : 1;

            cameraX = 0;
            coinsArr.forEach(c => c.collected = false);
            currentScore = 0; 
            updateScoreUI();

            const label = document.getElementById('effect-label');
            let labelText = "";
            if (currentPowerUps['pu_slow']) labelText = "üêå SCHLEICHFAHRT";
            if (currentPowerUps['pu_magnet']) labelText += " üß≤ MAGNET";
            if (currentPowerUps['pu_double'] && !playerData.doubleJumpUnlocked) labelText += " üöÄ 2x JUMP";
            
            if (labelText) {
                label.innerText = labelText;
                label.style.display = 'block';
            } else {
                label.style.display = 'none';
            }
        }

        function jump() {
            if (player.jumpsLeft > 0) {
                player.dy = JUMP_FORCE;
                player.jumpsLeft--;
            }
        }

        function die() {
            gameState = 'CRASHED';
            document.body.classList.add('shake');
            createParticles(player.x + player.w/2 - cameraX, player.y + player.h/2, playerData.skinColor, 20);
            setTimeout(() => {
                document.body.classList.remove('shake');
                
                if (currentScore > playerData.bestScore) {
                    playerData.bestScore = currentScore;
                    saveData();
                }
                updateCrashScreen(); 
                showModal('crash-screen');
            }, 300);
        }

        function togglePause() {
            if (gameState === 'PLAYING') {
                gameState = 'PAUSED';
                showModal('start-screen');
                document.querySelector('#start-screen h1').innerText = "Pause";
                document.querySelector('#start-screen button').innerText = "Weiter";
                document.querySelector('#start-screen .shop-close').style.display = "block";
            } else if (gameState === 'PAUSED') {
                hideAllModals();
                gameState = 'PLAYING';
                document.querySelector('#start-screen h1').innerText = "Geo Dash Ultimate";
                document.querySelector('#start-screen button').innerText = "Starten";
            }
        }

        // --- LOOP ---
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (gameState === 'PLAYING') update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            // Unendliche Generierung Trigger
            if (player.x > lastGeneratedX - 1000) {
                extendLevel();
            }

            player.x += SPEED_X;
            cameraX = player.x - 100;
            player.dy += GRAVITY;
            player.y += player.dy;

            let newScore = Math.floor(player.x / 10);
            if (newScore > currentScore) {
                currentScore = newScore;
                updateScoreUI();
            }

            if (!player.grounded) player.angle += 4; 
            else {
                const rest = player.angle % 90;
                if (rest > 45) player.angle += (90 - rest);
                else player.angle -= rest;
            }

            player.grounded = false;
            const nearbyBlocks = blocks.filter(b => b.x + b.w > player.x - 50 && b.x < player.x + player.w + 50);
            
            nearbyBlocks.forEach(b => {
                if (rectIntersect(player.x, player.y, player.w, player.h, b.x, b.y, b.w, b.h)) {
                    const prevY = player.y - player.dy;
                    if (prevY + player.h <= b.y + 10) {
                        player.grounded = true;
                        player.dy = 0;
                        player.y = b.y - player.h;
                        const hasDouble = (playerData.doubleJumpUnlocked && playerData.doubleJumpEnabled) || currentPowerUps['pu_double'];
                        player.jumpsLeft = hasDouble ? 2 : 1;
                    } else {
                        die();
                    }
                }
            });

            if (player.y > canvas.height) die();

            const nearbySpikes = spikes.filter(s => s.x + s.w > player.x - 10 && s.x < player.x + player.w + 10);
            nearbySpikes.forEach(s => {
                if (rectIntersect(player.x + 10, player.y + 10, player.w - 20, player.h - 20, s.x + 5, s.y + 10, s.w - 10, s.h - 10)) {
                    die();
                }
            });

            coinsArr.forEach(c => {
                if (!c.collected) {
                    if (currentPowerUps['pu_magnet']) {
                        const dx = (player.x + player.w/2) - c.x;
                        const dy = (player.y + player.h/2) - c.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < 300) { 
                            c.x += dx * 0.15;
                            c.y += dy * 0.15;
                        }
                    }

                    const dx = (player.x + player.w/2) - c.x;
                    const dy = (player.y + player.h/2) - c.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < player.w/2 + c.r) {
                        c.collected = true;
                        playerData.coins++;
                        saveData();
                        updateCoinUI();
                        createParticles(c.x - cameraX + canvas.width/2, c.y, '#ffd700', 5);
                    }
                }
            });

            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                if(p.life <= 0) particles.splice(i, 1);
            });
        }

        function draw() {
            ctx.save();
            ctx.strokeStyle = 'rgba(0, 243, 255, 0.05)';
            ctx.lineWidth = 1;
            const gridSize = 50;
            const offsetX = -(cameraX % gridSize);
            for(let x=offsetX; x<canvas.width; x+=gridSize) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); }
            for(let y=0; y<canvas.height; y+=gridSize) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }

            const renderX = (objX) => objX - cameraX;

            ctx.fillStyle = '#000';
            ctx.strokeStyle = '#00f3ff';
            ctx.lineWidth = 2;
            blocks.forEach(b => {
                if(b.x - cameraX > canvas.width + 100 || b.x + b.w - cameraX < -100) return;
                const rx = renderX(b.x);
                ctx.fillRect(rx, b.y, b.w, b.h);
                ctx.strokeRect(rx, b.y, b.w, b.h);
            });

            ctx.fillStyle = '#ff3333';
            ctx.shadowBlur = 5;
            ctx.shadowColor = '#ff3333';
            spikes.forEach(s => {
                if(s.x - cameraX > canvas.width + 100 || s.x + s.w - cameraX < -100) return;
                const rx = renderX(s.x);
                ctx.beginPath();
                ctx.moveTo(rx, s.y + 40);       
                ctx.lineTo(rx + s.w/2, s.y);    
                ctx.lineTo(rx + s.w, s.y + 40);
                ctx.closePath();
                ctx.fill();
            });
            ctx.shadowBlur = 0;

            ctx.fillStyle = '#ffd700';
            coinsArr.forEach(c => {
                if(c.collected) return;
                const rx = renderX(c.x);
                ctx.beginPath(); ctx.arc(rx, c.y, c.r, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(rx - 3, c.y - 3, 3, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#ffd700';
            });

            ctx.save();
            ctx.translate(renderX(player.x) + player.w/2, player.y + player.h/2);
            ctx.rotate(player.angle * Math.PI / 180);
            ctx.fillStyle = playerData.skinColor;
            ctx.shadowBlur = 15; ctx.shadowColor = playerData.skinColor;
            ctx.fillRect(-player.w/2, -player.h/2, player.w, player.h);
            ctx.fillStyle = '#000'; 
            ctx.fillRect(4, -12, 10, 10);
            ctx.fillRect(16, -12, 5, 5);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.strokeRect(-player.w/2, -player.h/2, player.w, player.h);
            ctx.restore();

            particles.forEach(p => { ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, p.size, p.size); });
            ctx.globalAlpha = 1;
            ctx.restore();
        }

        function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
            return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
        }

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 1.0, color: color, size: Math.random() * 5 + 2 });
            }
        }

        // --- HUD UPDATES ---
        function updateScoreUI() {
            document.getElementById('score-display').innerText = currentScore;
        }

        function updateCrashScreen() {
            document.getElementById('crash-score').innerText = currentScore;
            document.getElementById('crash-best-score').innerText = playerData.bestScore;
            document.getElementById('start-best-score').innerText = playerData.bestScore;
        }

        function updatePowerUpHUD() {
            const container = document.getElementById('active-powerups-display');
            container.innerHTML = '';
            effectItems.forEach(item => {
                if (currentPowerUps[item.id]) {
                    const icon = document.createElement('div');
                    icon.className = 'powerup-icon';
                    icon.innerText = item.icon;
                    container.appendChild(icon);
                }
            });
        }

        // --- SHOP LOGIK ---
        function openShop() {
            document.getElementById('shop-coins').innerText = playerData.coins;
            if (gameState === 'CRASHED') {
                Object.keys(currentPowerUps).forEach(k => currentPowerUps[k] = false);
                updatePowerUpHUD();
                document.getElementById('effect-label').style.display = 'none';
            }
            switchTab('skins');
            showModal('shop-screen');
        }

        function closeShop() {
            hideAllModals();
            if (gameState === 'START') showModal('start-screen');
            else if (gameState === 'PAUSED') gameState = 'PLAYING';
            else startGame();
        }

        function switchTab(tabName) {
            activeTab = tabName;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-'+tabName).classList.add('active');
            renderShopContent();
        }

        function renderShopContent() {
            const container = document.getElementById('shop-content');
            container.innerHTML = '';

            if (activeTab === 'skins') {
                const grid = document.createElement('div');
                grid.className = 'items-grid';
                skinItems.forEach(item => {
                    if (!item.owned && item.price > 0 && playerData.unlockedColors.includes(item.color)) item.owned = true;
                    const el = document.createElement('div');
                    el.className = 'shop-item';
                    const preview = document.createElement('div');
                    preview.className = 'item-preview';
                    preview.style.backgroundColor = item.color;
                    const name = document.createElement('span');
                    name.className = 'item-name';
                    name.innerText = item.name;
                    const price = document.createElement('span');
                    price.className = 'item-price';
                    price.innerText = item.owned ? 'Im Besitz' : (item.price + ' ü™ô');
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    if (item.owned) {
                        if (playerData.skinColor === item.color) { btn.innerText = "Ausgew√§hlt"; btn.disabled = true; }
                        else { btn.innerText = "Anziehen"; btn.onclick = () => { playerData.skinColor = item.color; saveData(); renderShopContent(); }; }
                    } else {
                        if (playerData.coins >= item.price) { btn.innerText = "Kaufen"; btn.onclick = () => { if (playerData.coins >= item.price) { playerData.coins -= item.price; playerData.unlockedColors.push(item.color); saveData(); updateCoinUI(); renderShopContent(); } }; }
                        else { btn.innerText = "Zu teuer"; btn.disabled = true; }
                    }
                    el.appendChild(preview); el.appendChild(name); el.appendChild(price); el.appendChild(btn);
                    grid.appendChild(el);
                });
                container.appendChild(grid);
            }
            else if (activeTab === 'effects') {
                const grid = document.createElement('div');
                grid.className = 'items-grid';
                effectItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'shop-item powerup-item';
                    if (currentPowerUps[item.id]) el.classList.add('active');
                    const icon = document.createElement('div');
                    icon.style.fontSize = '2rem';
                    icon.innerText = item.icon;
                    const name = document.createElement('span');
                    name.className = 'item-name';
                    name.innerText = item.name;
                    const price = document.createElement('span');
                    price.className = 'item-price';
                    price.innerText = item.cost + ' ü™ô';
                    el.appendChild(icon); el.appendChild(name); el.appendChild(price);
                    el.onclick = () => {
                        if (currentPowerUps[item.id]) { currentPowerUps[item.id] = false; } 
                        else { if (playerData.coins >= item.cost) { playerData.coins -= item.cost; currentPowerUps[item.id] = true; saveData(); updateCoinUI(); document.getElementById('shop-coins').innerText = playerData.coins; } }
                        updatePowerUpHUD();
                        renderShopContent();
                    };
                    grid.appendChild(el);
                });
                container.appendChild(grid);
            }
            else if (activeTab === 'game') {
                const list = document.createElement('div');
                list.style.display = 'flex'; list.style.flexDirection = 'column'; list.style.gap = '20px'; list.style.padding = '10px';
                gameItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'shop-item'; el.style.flexDirection = 'row'; el.style.justifyContent = 'space-between';
                    
                    let priceHtml = '';
                    if (!playerData.doubleJumpUnlocked) {
                        priceHtml = `<div style="color:#ffd700; font-weight:bold; font-size:1.2rem; margin-top:5px;">${item.price} ü™ô</div>`;
                    }

                    const info = document.createElement('div');
                    info.style.textAlign = 'left';
                    info.innerHTML = `<span style="display:block;font-weight:bold;font-size:1.2rem;">${item.name}</span>
                                      <span style="color:#aaa;">${item.desc}</span>
                                      ${priceHtml}`;

                    const actionContainer = document.createElement('div');
                    actionContainer.style.display = 'flex'; actionContainer.style.flexDirection = 'column'; actionContainer.style.gap = '5px'; actionContainer.style.minWidth = '100px';
                    
                    if (playerData.doubleJumpUnlocked) {
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'action-btn';
                        toggleBtn.className += (playerData.doubleJumpEnabled ? ' active' : '');
                        toggleBtn.style.background = playerData.doubleJumpEnabled ? 'var(--neon-blue)' : 'transparent';
                        toggleBtn.style.color = playerData.doubleJumpEnabled ? 'black' : 'var(--neon-blue)';
                        toggleBtn.innerText = playerData.doubleJumpEnabled ? "AN" : "AUS";
                        toggleBtn.onclick = () => { playerData.doubleJumpEnabled = !playerData.doubleJumpEnabled; saveData(); renderShopContent(); };
                        actionContainer.appendChild(toggleBtn);
                    } else {
                        const buyBtn = document.createElement('button');
                        buyBtn.className = 'action-btn';
                        if (playerData.coins >= item.price) { buyBtn.innerText = "Freischalten"; buyBtn.onclick = () => { if (playerData.coins >= item.price) { playerData.coins -= item.price; playerData.doubleJumpUnlocked = true; playerData.doubleJumpEnabled = true; saveData(); updateCoinUI(); renderShopContent(); } }; }
                        else { buyBtn.innerText = "Zu teuer"; buyBtn.disabled = true; }
                        actionContainer.appendChild(buyBtn);
                    }
                    el.appendChild(info); el.appendChild(actionContainer); list.appendChild(el);
                });
                container.appendChild(list);
            }
        }

        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function hideAllModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        function updateCoinUI() { document.getElementById('coin-display').innerText = playerData.coins; }

        window.onload = init;

    </script>
</body>
</html>
